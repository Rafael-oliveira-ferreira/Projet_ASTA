<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <title>Accueil</title>
</head>
<body class="layout" th:attr="data-mentor-id=${apprenticementor != null ? apprenticementor.id : 0}">
<header class="header">
    <nav class="nav">
        <!-- badge de bienvenue (à la place d’un bouton) -->
        <span class="user_badge"
              th:text="|Bienvenue ${apprenticementor.firstName} ${apprenticementor.lastName}|">
        Bienvenue Jean Smith
      </span>
        <form class="search" id="search-form" role="search" th:action="@{/recherche/{id}(id=${apprenticementor.id})}" method="get">
            <!-- icône -->
            <svg class="search__icon" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 21l-4.3-4.3m2.3-6.2A7 7 0 1 1 5 5a7 7 0 0 1 14 0z"
                      fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>

            <input type="search"
                   class="search__input"
                   id ="search-input"
                   name="q"
                   placeholder="Rechercher..."
                   th:value="${param.q}" />
            <button type="button" id="reset-search" class="btn-ghost">Réinitialiser</button>
            <p id="search-error" style="display:none;color:#b00020;margin-top:.4rem;">La recherche a échoué.</p>
        </form>
        <form th:action="@{/logout}" method="post" class="logout-form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn-logout btn-ghost">Se déconnecter</button>
        </form>
    </nav>
</header>

<main class="main">
    <h1>Bienvenue sur ASTA</h1>
</main>

<section id="apprentices-section" style="margin-top: 1rem;">
    <h2>Apprentis</h2>
    <table id="apprentices-table" aria-describedby="apprentices-section">
        <thead>
        <tr>
            <th>Id</th>
            <th>Prénom</th>
            <th>Nom</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody id="apprentices-tbody">
        <!-- rows injected here -->
        </tbody>
    </table>
    <p id="no-apprentices" style="display:none;">Aucun apprenti trouvé</p>
</section>

<script>
    (function () {
        function renderApprenticesTable(apprentices) {
            var tbody = document.getElementById('apprentices-tbody');
            var noMsg = document.getElementById('no-apprentices');
            tbody.innerHTML = '';

            if (!Array.isArray(apprentices) || apprentices.length === 0) {
                noMsg.style.display = '';
                return;
            }
            noMsg.style.display = 'none';

            apprentices.forEach(function (a) {
                let tr = document.createElement('tr');

                let tdId = document.createElement('td');
                tdId.textContent = a.id != null ? a.id : '';
                tr.appendChild(tdId);

                let tdFirst = document.createElement('td');
                tdFirst.textContent = a.firstName != null ? a.firstName : '';
                tr.appendChild(tdFirst);

                let tdLast = document.createElement('td');
                tdLast.textContent = a.lastName != null ? a.lastName : '';
                tr.appendChild(tdLast);

                // Actions cell (Modifier / Supprimer) - no logic yet
                let tdActions = document.createElement('td');

                let btnEdit = document.createElement('button');
                btnEdit.type = 'button';
                btnEdit.textContent = 'Modifier';
                btnEdit.className = 'btn-edit';
                btnEdit.setAttribute('data-id', a.id);
                btnEdit.addEventListener('click', function () {
                    window.location.href = '/apprentice/' + a.id;
                });
                tdActions.appendChild(btnEdit);

                let spacer = document.createTextNode(' ');
                tdActions.appendChild(spacer);

                let btnDelete = document.createElement('button');
                btnDelete.type = 'button';
                btnDelete.textContent = 'Supprimer';
                btnDelete.className = 'btn-delete';
                btnDelete.setAttribute('data-id', a.id);
                tdActions.appendChild(btnDelete);

                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var mentorIdRaw = document.body.dataset.mentorId;
            var mentorId = (mentorIdRaw && mentorIdRaw !== '0') ? Number(mentorIdRaw) : null;
            const form = document.getElementById('search-form');
            const searchInput = document.querySelector('.search__input');
            var resetBtn = document.getElementById('reset-search');
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query)
                    return;
                searchApprentices(query);
            });

            if (resetBtn){
                resetBtn.addEventListener('click', function () {
                    searchInput.value = '';    // ← vider le champ
                    hideError();
                    searchApprentices('');     // ← relancer la recherche vide = liste complète
                });
            }

            if (mentorId === null) {
                console.log('No mentor id available');
                return;
            }

            fetch('/apprenticesByMentorId/' + mentorId)
                .then(function (response) {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                    return response.json();
                })
                .then(function (apprentices) {
                    renderApprenticesTable(apprentices);
                })
                .catch(function (err) {
                    console.error('Failed to load apprentices:', err);
                    // optionally show user-friendly message
                });
        });

        function searchApprentices(query) {
            var mentorIdRaw = document.body.dataset.mentorId;
            var mentorId = (mentorIdRaw && mentorIdRaw !== '0') ? Number(mentorIdRaw) : null;

            if (mentorId === null) {
                console.log('No mentor id available');
                return;
            }
            hideError()
            fetch('/recherche/' + mentorId + '?query=' + encodeURIComponent(query || ''))
                .then(function (response) {
                    if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
                    return response.json();
                })
                .then(function (apprentices) {
                    renderApprenticesTable(apprentices);
                })
                .catch(function (err) {
                    console.error('Failed to load apprentices:', err);
                    showError('La recherche a échoué.');
                    // optionally show user-friendly message
                });
        }
        function showError(message) {
            var err = document.getElementById('search-error');
            if (!err) return;
            err.textContent = message || 'La recherche a échoué.';
            err.style.display = '';
        }

        function hideError() {
            var err = document.getElementById('search-error');
            if (!err) return;
            err.style.display = 'none';
        }
    })();
</script>
</body>
</html>