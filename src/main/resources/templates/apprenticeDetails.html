<!doctype html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Réutilise le même style que la page d’accueil -->
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <title>Détails apprenti</title>
</head>
<body th:attr="data-apprentice-id=${apprentice != null ? apprentice.id : 0}">

<!-- NAV identique à la home, mais sans recherche.
     Le bouton de retour est CENTRÉ dans la barre -->
<header class="header">
    <nav class="nav">
        <!-- Colonne gauche : badge utilisateur -->
        <span class="user_badge"
              th:text="|Bienvenue ${apprentice.apprenticeshipMentor.firstName} ${apprentice.apprenticeshipMentor.lastName}|">
      Bienvenue Jean Smith
    </span>
        <div></div>
        <div class="buttons-container">
            <form th:action="@{/logout}" method="post" class="logout-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn-logout btn-ghost">Se déconnecter</button>
            </form>
        </div>
    </nav>
</header>


<main class="main">
    <a class="btn-return" th:href="@{/home}">← Retour à l’accueil</a>
    <!-- Apprentice details -->
    <section id="apprentice-details-section" class="card">
        <div class="card__header">
            <h2 class="card__title">Détails de l'apprenti</h2>
            <div class="card__actions">
                <button type="button" class="btn-edit" aria-label="Modifier apprenti" onclick="startEdit()">Modifier</button>
                <button type="button" class="btn-save hidden" aria-label="Enregistrer les modifications"
                        th:onclick="|saveEdit(${apprentice.id}, ${apprentice.company != null ? apprentice.company.id : null})|">
                    Enregistrer
                </button>
            </div>
        </div>

        <div class="card__body">
            <div class="info-grid">
                <div class="info-block">
                    <h3 class="info-block__title">Identité</h3>
                    <dl class="dl">
                        <div class="dl__row">
                            <dt>Nom</dt><dd id="span_last_name" th:text="${apprentice != null ? apprentice.lastName : ''}"></dd>
                        </div>
                        <div class="dl__row">
                            <dt>Prénom</dt><dd id="span_first_name" th:text="${apprentice != null ? apprentice.firstName : ''}"></dd>
                        </div>
                        <div class="dl__row">
                            <dt>Email</dt><dd id="span_email" th:text="${apprentice != null ? apprentice.email : ''}"></dd>
                        </div>
                        <div class="dl__row">
                            <dt>Téléphone</dt><dd id="span_phone" th:text="${apprentice.phone}"></dd>
                        </div>
                        <div class="dl__row" th:if="${apprentice.major}">
                            <dt>Parcours</dt>
                            <dd>
                                <span id="span_program" th:text="${apprentice.program}"></span>
                                <span id="span_major" th:text="' ' + ${apprentice.major}"></span>
                            </dd>
                        </div>
                        <div class="dl__row" th:if="${apprentice.academicYear}">
                            <dt>Année académique</dt><dd id="span_academic_year" th:text="${apprentice.academicYear}"></dd>
                        </div>
                    </dl>
                </div>

                <div class="info-block" th:if="${apprentice.company}">
                    <h3 class="info-block__title">Entreprise</h3>
                    <dl class="dl">
                        <div class="dl__row">
                            <dt>Nom</dt><dd id="span_company_name" th:text="${apprentice.company.companyName}"></dd>
                        </div>
                        <div class="dl__row">
                            <dt>Adresse</dt>
                            <dd id="span_company_address"
                                th:text="${apprentice.company.address != null ? apprentice.company.address : 'Non renseigné'}"></dd>
                        </div>
                        <div class="dl__row">
                            <dt>Infos d’accès</dt>
                            <dd id="span_company_info"
                                th:text="${apprentice.company.accessInfo != null ? apprentice.company.accessInfo : 'Non renseigné'}"></dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Sous-fiches -->
        <div class="subcards">
            <article class="subcard">
                <header class="subcard__header"><h4>Mission</h4></header>
                <div class="subcard__body" id="mission-details">
                    <dl class="dl dl--compact">
                        <div class="dl__row"><dt>Mots-clés</dt><dd id="span_mission_keywords"></dd></div>
                        <div class="dl__row"><dt>Poste ciblé</dt><dd id="span_mission_target"></dd></div>
                        <div class="dl__row"><dt>Commentaires</dt><dd id="span_mission_comments"></dd></div>
                    </dl>
                </div>
            </article>

            <article class="subcard">
                <header class="subcard__header"><h4>Visite</h4></header>
                <div class="subcard__body" id="visit-details">
                    <dl class="dl dl--compact">
                        <div class="dl__row"><dt>Format</dt><dd id="visit-format"></dd></div>
                        <div class="dl__row"><dt>Date</dt><dd id="visit-date"></dd></div>
                        <div class="dl__row"><dt>Commentaires</dt><dd id="visit-comments"></dd></div>
                    </dl>
                </div>
            </article>

            <article class="subcard">
                <header class="subcard__header"><h4>Soutenance</h4></header>
                <div class="subcard__body" id="defense-details">
                    <dl class="dl dl--compact">
                        <div class="dl__row"><dt>Date</dt><dd id="denfense-date"></dd></div>
                        <div class="dl__row"><dt>Note</dt><dd id="defense-grade"></dd></div>
                        <div class="dl__row"><dt>Commentaires</dt><dd id="defense-comments"></dd></div>
                    </dl>
                </div>
            </article>

            <article class="subcard">
                <header class="subcard__header"><h4>Rapport</h4></header>
                <div class="subcard__body" id="report-details">
                    <dl class="dl dl--compact">
                        <div class="dl__row"><dt>Sujet</dt><dd id="report-subject"></dd></div>
                        <div class="dl__row"><dt>Note</dt><dd id="report-grade"></dd></div>
                        <div class="dl__row"><dt>Commentaires</dt><dd id="report-comments"></dd></div>
                    </dl>
                </div>
            </article>
        </div>
    </section>
</main>

<!-- Tes scripts existants inchangés -->
<script>
    let defenseId = null; // to be set when loading defense data
    let missionId = null; // to be set when loading mission data
    let reportId = null;  // to be set when loading report data
    let visitId = null;   // to be set when loading visit data

    function readCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
        return {token, header};
    }

    function startEdit() {
        // spans become inputs
        const spanLastName = document.getElementById('span_last_name');
        const spanFirstName = document.getElementById('span_first_name');
        const spanEmail = document.getElementById('span_email');
        const spanPhone = document.getElementById('span_phone');
        const spanProgram = document.getElementById('span_program');
        const spanMajor = document.getElementById('span_major');
        const spanAcademicYear = document.getElementById('span_academic_year');
        const spanCompanyName = document.getElementById('span_company_name');
        const spanCompanyAddress = document.getElementById('span_company_address');
        const spanCompanyInfo = document.getElementById('span_company_info');
        const missionDetails = document.getElementById('mission-details');
        const missionPlaceholder = document.getElementById('mission-placeholder');
        const spanMissionKeywords = document.getElementById('span_mission_keywords');
        const spanMissionTarget = document.getElementById('span_mission_target');
        const spanMissionComments = document.getElementById('span_mission_comments');
        const visitDetails = document.getElementById('visit-details');
        const visitPlaceholder = document.getElementById('visit-placeholder');
        const visitFormat = document.getElementById('visit-format');
        const visitDate = document.getElementById('visit-date');
        const visitComments = document.getElementById('visit-comments');
        const defenseDetails = document.getElementById('defense-details');
        const defensePlaceholder = document.getElementById('defense-placeholder');
        const defenseDate = document.getElementById('denfense-date');
        const defenseGrade = document.getElementById('defense-grade');
        const defenseComments = document.getElementById('defense-comments');
        const reportDetails = document.getElementById('report-details');
        const reportPlaceholder = document.getElementById('report-placeholder');
        const reportSubject = document.getElementById('report-subject');
        const reportGrade = document.getElementById('report-grade');
        const reportComments = document.getElementById('report-comments');
        document.querySelector('.btn-edit').classList.add('hidden');
        document.querySelector('.btn-save').classList.remove('hidden');

        spanLastName.innerHTML = `<input type="text" id="input_last_name" value="${spanLastName.textContent}">`;
        spanFirstName.innerHTML = `<input type="text" id="input_first_name" value="${spanFirstName.textContent}">`;
        spanEmail.innerHTML = `<input type="text" id="input_email" value="${spanEmail.textContent}">`;
        spanPhone.innerHTML = `<input type="text" id="input_phone" value="${spanPhone.textContent}">`;
        if (spanProgram) {
            spanProgram.innerHTML = `<input type="text" id="input_program" value="${spanProgram.textContent}">`;
        }
        if (spanMajor) {
            spanMajor.innerHTML = `<input type="text" id="input_major" value="${spanMajor.textContent}">`;
        }
        if (spanAcademicYear) {
            spanAcademicYear.innerHTML = `<input type="text" id="input_academic_year" value="${spanAcademicYear.textContent}">`;
        }
        if (spanCompanyName) {
            spanCompanyName.innerHTML = `<input type="text" id="input_company_name" value="${spanCompanyName.textContent}">`;
        }
        if (spanCompanyAddress) {
            spanCompanyAddress.innerHTML = `<input type="text" id="input_company_address" value="${spanCompanyAddress.textContent}">`;
        }
        if (spanCompanyInfo) {
            spanCompanyInfo.innerHTML = `<input type="text" id="input_company_info" value="${spanCompanyInfo.textContent}">`;
        }
        if (missionPlaceholder) {
            missionPlaceholder.classList.add('hidden');
            missionDetails.classList.remove('hidden');
            spanMissionKeywords.innerHTML = `<input type="text" id="input_mission_keywords" value="">`;
            spanMissionTarget.innerHTML = `<input type="text" id="input_mission_target" value="">`;
            spanMissionComments.innerHTML = `<input type="text" id="input_mission_comments" value="">`;
        } else {
            spanMissionKeywords.innerHTML = `<input type="text" id="input_mission_keywords" value="${spanMissionKeywords.textContent}">`;
            spanMissionTarget.innerHTML = `<input type="text" id="input_mission_target" value="${spanMissionTarget.textContent}">`;
            spanMissionComments.innerHTML = `<input type="text" id="input_mission_comments" value="${spanMissionComments.textContent}">`;
        }
        if (visitPlaceholder) {
            visitPlaceholder.classList.add('hidden');
            visitDetails.classList.remove('hidden');
            visitFormat.innerHTML = `<input type="text" id="input_visit_format" value="">`;
            visitDate.innerHTML = `<input type="date" id="input_visit_date" value="">`;
            visitComments.innerHTML = `<input type="text" id="input_visit_comments" value="">`;
        } else {
            visitFormat.innerHTML = `<input type="text" id="input_visit_format" value="${visitFormat.textContent}">`;
            visitDate.innerHTML = `<input type="date" id="input_visit_date" value="${visitDate.textContent}">`;
            visitComments.innerHTML = `<input type="text" id="input_visit_comments" value="${visitComments.textContent}">`;
        }
        if (defensePlaceholder) {
            defensePlaceholder.classList.add('hidden');
            defenseDetails.classList.remove('hidden');
            defenseDate.innerHTML = `<input type="date" id="input_defense_date" value="">`;
            defenseGrade.innerHTML = `<input type="text" id="input_defense_grade" value="">`;
            defenseComments.innerHTML = `<input type="text" id="input_defense_comments" value="">`;
        } else {
            defenseDate.innerHTML = `<input type="date" id="input_defense_date" value="${defenseDate.textContent}">`;
            defenseGrade.innerHTML = `<input type="text" id="input_defense_grade" value="${defenseGrade.textContent}">`;
            defenseComments.innerHTML = `<input type="text" id="input_defense_comments" value="${defenseComments.textContent}">`;
        }
        if (reportPlaceholder) {
            reportPlaceholder.classList.add('hidden');
            reportDetails.classList.remove('hidden');
            reportSubject.innerHTML = `<input type="text" id="input_report_subject" value="">`;
            reportGrade.innerHTML = `<input type="text" id="input_report_grade" value="">`;
            reportComments.innerHTML = `<input type="text" id="input_report_comments" value="">`;
        } else {
            reportSubject.innerHTML = `<input type="text" id="input_report_subject" value="${reportSubject.textContent}">`;
            reportGrade.innerHTML = `<input type="text" id="input_report_grade" value="${reportGrade.textContent}">`;
            reportComments.innerHTML = `<input type="text" id="input_report_comments" value="${reportComments.textContent}">`;
        }
    }

    function saveEdit(apprenticeId, companyId) {
        const companyNameVal = (document.getElementById('input_company_name')?.value || '').trim();
        const companyAddressVal = (document.getElementById('input_company_address')?.value || '').trim();
        const companyAccessInfoVal = (document.getElementById('input_company_info')?.value || '').trim();

        let companyData = null;
        if (companyNameVal || companyAddressVal || companyAccessInfoVal) {
            companyData = {
                companyName: companyNameVal || null,
                address: companyAddressVal || null,
                accessInfo: companyAccessInfoVal || null
            };
        }

        const missionKeywordsVal = (document.getElementById('input_mission_keywords')?.value || '').trim();
        const missionTargetVal = (document.getElementById('input_mission_target')?.value || '').trim();
        const missionCommentsVal = (document.getElementById('input_mission_comments')?.value || '').trim();

        let missionData = null;
        if (missionKeywordsVal || missionTargetVal || missionCommentsVal) {
            missionData = {
                apprentice: { id: apprenticeId },
                keywords: missionKeywordsVal || null,
                targetJob: missionTargetVal || null,
                comments: missionCommentsVal || null
            };
        }

        const visitFormatVal = (document.getElementById('input_visit_format')?.value || '').trim();
        const visitDateVal = (document.getElementById('input_visit_date')?.value || '').trim();
        const visitCommentsVal = (document.getElementById('input_visit_comments')?.value || '').trim();

        let visitData = null;
        if (visitFormatVal || visitDateVal || visitCommentsVal) {
            visitData = {
                apprentice: { id: apprenticeId },
                format: visitFormatVal || null,
                visitDate: visitDateVal || null,
                comments: visitCommentsVal || null
            };
        }

        const defenseDateVal = (document.getElementById('input_defense_date')?.value || '').trim();
        const defenseGradeVal = (document.getElementById('input_defense_grade')?.value || '').trim();
        const defenseCommentsVal = (document.getElementById('input_defense_comments')?.value || '').trim();

        let defenseData = null;
        if (defenseDateVal || defenseGradeVal || defenseCommentsVal) {
            defenseData = {
                apprentice: { id: apprenticeId },
                defenseDate: defenseDateVal || null,
                grade: defenseGradeVal || null,
                comments: defenseCommentsVal || null
            };
        }

        const reportSubjectVal = (document.getElementById('input_report_subject')?.value || '').trim();
        const reportGradeVal = (document.getElementById('input_report_grade')?.value || '').trim();
        const reportCommentsVal = (document.getElementById('input_report_comments')?.value || '').trim();

        let reportData = null;
        if (reportSubjectVal || reportGradeVal || reportCommentsVal) {
            reportData = {
                apprentice: { id: apprenticeId },
                subject: reportSubjectVal || null,
                grade: reportGradeVal || null,
                comments: reportCommentsVal || null
            };
        }

        if (companyData) {
            updateField('Company', companyId, companyData);
        }

        if (missionData) {
            updateField('Mission', missionId, missionData);
        }

        if (visitData) {
            updateField('Visit', visitId, visitData);
        }

        if (defenseData) {
            updateField('Defense', defenseId, defenseData);
        }

        if (reportData) {
            updateField('Report', reportId, reportData);
        }
        document.querySelector('.btn-edit').classList.add('hidden');
        document.querySelector('.btn-save').classList.remove('hidden');

        revertFields();
    }

    function revertFields() {
        const get = id => document.getElementById(id);

        const setSpanFromInput = (spanId, inputId, formatter) => {
            const span = get(spanId);
            if (!span) return;
            const input = get(inputId);
            if (!input) return;
            const val = (input.value || '').trim();
            span.textContent = formatter ? formatter(val) : val;
        };

        // basic fields
        setSpanFromInput('span_last_name', 'input_last_name');
        setSpanFromInput('span_first_name', 'input_first_name');
        setSpanFromInput('span_email', 'input_email');
        setSpanFromInput('span_phone', 'input_phone');

        // academic / program
        setSpanFromInput('span_program', 'input_program');
        setSpanFromInput('span_major', 'input_major');
        setSpanFromInput('span_academic_year', 'input_academic_year');

        // company
        setSpanFromInput('span_company_name', 'input_company_name');
        setSpanFromInput('span_company_address', 'input_company_address');
        setSpanFromInput('span_company_info', 'input_company_info');

        // mission
        setSpanFromInput('span_mission_keywords', 'input_mission_keywords');
        setSpanFromInput('span_mission_target', 'input_mission_target');
        setSpanFromInput('span_mission_comments', 'input_mission_comments');

        // visit (format date)
        setSpanFromInput('visit-format', 'input_visit_format');
        setSpanFromInput('visit-date', 'input_visit_date', v => v ? (new Date(v).toLocaleDateString('fr-FR')) : '');
        setSpanFromInput('visit-comments', 'input_visit_comments');

        // defense (note: HTML uses id "denfense-date")
        setSpanFromInput('denfense-date', 'input_defense_date', v => v ? (new Date(v).toLocaleDateString('fr-FR')) : '');
        setSpanFromInput('defense-grade', 'input_defense_grade');
        setSpanFromInput('defense-comments', 'input_defense_comments');

        // report
        setSpanFromInput('report-subject', 'input_report_subject');
        setSpanFromInput('report-grade', 'input_report_grade');
        setSpanFromInput('report-comments', 'input_report_comments');

        // toggle buttons visibility (restore edit/save state)
        const btnEdit = document.querySelector('.btn-edit');
        const btnSave = document.querySelector('.btn-save');
        if (btnEdit) btnEdit.classList.remove('hidden');
        if (btnSave) btnSave.classList.add('hidden');
    }

    function addField(name, data) {
        const url = '/create' + name + '/';
        const payload = JSON.stringify(data);
        console.log('Creating', name, data);

        const {token, header} = readCsrf();
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
        if (token) headers[header] = token;

        return fetch(url, {
            method: 'POST',
            headers: headers,
            body: payload,
            credentials: 'same-origin'
        })
            .then(function (response) {
                if (!response.ok) return response.text().then(t => {
                    throw new Error('Network response was not ok: ' + response.status + ' ' + t);
                });
                return response.json().catch(() => null);
            })
            .then(function (addedItem) {
                console.log('Successfully added', addedItem);
                return addedItem;
            })
            .catch(function (err) {
                console.error('Failed to add field:', err);
                throw err;
            });
    }

    function updateField(name, id, data) {
        if (id == null) return addField(name, data);
        if (data == null) return Promise.resolve(null);

        const url = '/update' + name + '/' + id;
        const payload = JSON.stringify(data);
        console.log("Data to update:", data);

        const {token, header} = readCsrf();
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
        if (token) headers[header] = token;

        return fetch(url, {
            method: 'PUT',
            headers: headers,
            body: payload,
            credentials: 'same-origin'
        })
            .then(function (response) {
                if (!response.ok) return response.text().then(text => {
                    throw new Error('Network response was not ok: ' + response.status + ' ' + text);
                });
                return response.json().catch(() => null);
            })
            .then(function (result) {
                console.log('Successfully updated');
                return result;
            })
            .catch(function (err) {
                console.error('Failed to update field:', err);
                throw err;
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const apprenticeIdRaw = document.body.dataset.apprenticeId;
        const apprenticeId = (apprenticeIdRaw && apprenticeIdRaw !== '0') ? Number(apprenticeIdRaw) : null;

        if (apprenticeId === null) {
            console.log('No apprentice id available');
            return;
        }

        Promise.all([
            fetch('/missionByApprenticeId/' + apprenticeId, {credentials: 'same-origin'})
                .then(r => r.ok ? r.json() : null).catch(err => {
                console.error('mission fetch failed', err);
                return null;
            }),
            fetch('/visitByApprenticeId/' + apprenticeId, {credentials: 'same-origin'})
                .then(r => r.ok ? r.json() : null).catch(err => {
                console.error('visit fetch failed', err);
                return null;
            }),
            fetch('/reportByApprenticeId/' + apprenticeId, {credentials: 'same-origin'})
                .then(r => r.ok ? r.json() : null).catch(err => {
                console.error('report fetch failed', err);
                return null;
            }),
            fetch('/defenseByApprenticeId/' + apprenticeId, {credentials: 'same-origin'})
                .then(r => r.ok ? r.json() : null).catch(err => {
                console.error('defense fetch failed', err);
                return null;
            })
        ])
            .then(function ([mission, visit, report, defense]) {
                console.log('Related entities loaded:', {mission, visit, report, defense});
                const firstMission = mission && mission.length > 0 ? mission[0] : null;
                const firstVisit = visit && visit.length > 0 ? visit[0] : null
                const firstReport = report && report.length > 0 ? report[0] : null;
                const firstDefense = defense && defense.length > 0 ? defense[0] : null

                missionId = firstMission ? firstMission.id : null;
                visitId = firstVisit ? firstVisit.id : null;
                reportId = firstReport ? firstReport.id : null;
                defenseId = firstDefense ? firstDefense.id : null;

                if (firstMission) {
                    document.getElementById('span_mission_keywords').textContent = firstMission.keywords || '';
                    document.getElementById('span_mission_target').textContent = firstMission.targetJob || '';
                    document.getElementById('span_mission_comments').textContent = firstMission.comments || '';
                }

                if (firstVisit) {
                    document.getElementById('visit-format').textContent = firstVisit.format || '';
                    document.getElementById('visit-date').textContent = firstVisit.visitDate ? new Date(firstVisit.visitDate).toLocaleDateString('fr-FR') : '';
                    document.getElementById('visit-comments').textContent = firstVisit.comments || '';
                }

                if (firstReport) {
                    document.getElementById('report-subject').textContent = firstReport.subject || '';
                    document.getElementById('report-grade').textContent = firstReport.grade || '';
                    document.getElementById('report-comments').textContent = firstReport.comments || '';
                }

                if (firstDefense) {
                    document.getElementById('denfense-date').textContent = firstDefense.defenseDate ? new Date(firstDefense.defenseDate).toLocaleDateString('fr-FR') : '';
                    document.getElementById('defense-grade').textContent = firstDefense.grade || '';
                    document.getElementById('defense-comments').textContent = firstDefense.comments || '';
                }
            })
            .catch(function (err) {
                console.error('Failed to load related entities:', err);
            });
    });
</script>
</body>
</html>
